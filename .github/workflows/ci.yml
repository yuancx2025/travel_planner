name: CI Pipeline
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint-and-test:
    name: Lint & Test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Lint with ruff
        run: |
          echo "ğŸ” Running linter..."
          ruff check .
          echo "âœ… Linting passed"
      
      - name: Test - Tools
        run: |
          echo "ğŸ§ª Testing tools..."
          pytest tests/tools/ -v --cov=tools --cov-report=term-missing --cov-report=xml:coverage-tools.xml
          echo "âœ… Tool tests passed"
      
      - name: Test - Agents
        run: |
          echo "ğŸ¤– Testing agents..."
          pytest tests/agents/ -v --cov=agents --cov-report=term-missing --cov-report=xml:coverage-agents.xml
          echo "âœ… Agent tests passed"
      
      - name: Test - Workflows
        run: |
          echo "ğŸ”„ Testing workflows..."
          pytest tests/workflows/ -v --cov=workflows --cov-report=term-missing --cov-report=xml:coverage-workflows.xml
          echo "âœ… Workflow tests passed"
      
      - name: Test - Integration (All)
        run: |
          echo "ğŸ¯ Running full test suite..."
          pytest tests/ -v --cov=. --cov-report=term-missing --cov-report=xml:coverage-all.xml --cov-report=html
          echo "âœ… All tests passed"
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage-all.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
      
      - name: Test Summary
        if: always()
        run: |
          echo "================================================"
          echo "           ğŸ‰ CI Pipeline Complete             "
          echo "================================================"
          echo "âœ… Linting: Passed"
          echo "âœ… Tool Tests: Passed"
          echo "âœ… Agent Tests: Passed"
          echo "âœ… Workflow Tests: Passed"
          echo "âœ… Integration Tests: Passed"
          echo "================================================"